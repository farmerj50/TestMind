// apps/api/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TestPriority {
  low
  medium
  high
}

enum TestCaseStatus {
  draft
  active
  archived
}

enum TestCaseType {
  functional
  regression
  security
  accessibility
  other
}

enum PlanTier {
  free
  starter
  pro
  team
}

enum TestResultStatus {
  passed
  failed
  skipped
  error
}

enum TestRunStatus {
  queued
  running
  succeeded
  failed
}

enum HealingStatus {
  queued
  running
  succeeded
  failed
  skipped
}

enum AgentSessionStatus {
  draft
  running
  ready
  failed
}

enum AgentPageStatus {
  pending
  running
  completed
  failed
}

enum AgentScenarioStatus {
  suggested
  accepted
  rejected
  completed
}

enum SecurityScanStatus {
  queued
  running
  completed
  failed
}

enum SecurityFindingType {
  recon
  static_analysis
  dependency
  dynamic
}

enum SecuritySeverity {
  info
  low
  medium
  high
  critical
}

model User {
  id               String            @id
  plan             PlanTier?
  projects         Project[]
  createdAt        DateTime          @default(now())
  AgentSession     AgentSession[]
  jiraIntegrations JiraIntegration[]
}

model Project {
  id        String   @id @default(cuid())
  name      String
  repoUrl   String
  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id])
  plan      PlanTier @default(free)
  createdAt DateTime @default(now())
  sharedSteps Json?   @default("{}")

  testRuns         TestRun[]
  suites           TestSuite[]
  cases            TestCase[]
  AgentSession     AgentSession[]
  AgentScenario    AgentScenario[]
  jiraIntegrations JiraIntegration[]
  integrations     Integration[]
  secrets          ProjectSecret[]
  securityScans    SecurityScanJob[]
  curatedSuites    CuratedSuite[]
}

model GitAccount {
  id        String   @id @default(cuid())
  provider  String   @default("github")
  userId    String
  token     String
  githubUserId Int?
  githubLogin  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, userId])
  @@index([userId])
}

model TestRun {
  id         String        @id @default(cuid())
  projectId  String
  project    Project       @relation(fields: [projectId], references: [id])
  status     TestRunStatus @default(queued)
  summary    String?
  error      String?
  createdAt  DateTime      @default(now())
  startedAt  DateTime?
  finishedAt DateTime?
  issueUrl   String?

  framework  String? // "playwright"
  trigger    String? // "user" | "schedule" | "webhook"
  envName    String?
  paramsJson Json?

  rerunOfId String?
  rerunOf   TestRun?  @relation("RunReruns", fields: [rerunOfId], references: [id])
  reruns    TestRun[] @relation("RunReruns")

  reportPath    String?
  artifactsJson Json?

  results            TestResult[]
  TestHealingAttempt TestHealingAttempt[]

  @@index([rerunOfId])
  @@index([projectId, createdAt])
}

model TestSuite {
  id        String      @id @default(cuid())
  projectId String
  project   Project     @relation(fields: [projectId], references: [id])
  name      String
  parentId  String?
  parent    TestSuite?  @relation("SuiteChildren", fields: [parentId], references: [id])
  children  TestSuite[] @relation("SuiteChildren")
  order     Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  cases TestCase[]

  @@index([projectId, parentId, order])
}

model TestCase {
  id            String         @id @default(cuid())
  projectId     String
  project       Project        @relation(fields: [projectId], references: [id])
  suiteId       String?
  suite         TestSuite?     @relation(fields: [suiteId], references: [id])
  key           String         @default(cuid())
  title         String
  priority      TestPriority   @default(medium)
  status        TestCaseStatus @default(active)
  type          TestCaseType   @default(functional)
  tags          String[]       @default([])
  preconditions String?        @db.Text
  lastAiSyncAt  DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  results            TestResult[]
  TestHealingAttempt TestHealingAttempt[]
  steps             TestStep[]
  runs              TestCaseRun[]

  @@unique([projectId, key])
  @@index([projectId, suiteId])
}

model TestResult {
  id    String  @id @default(cuid())
  runId String
  run   TestRun @relation(fields: [runId], references: [id])

  testCaseId String
  testCase   TestCase @relation(fields: [testCaseId], references: [id])

  status          TestResultStatus
  durationMs      Int?
  message         String?
  createdAt       DateTime             @default(now())
  healingAttempts TestHealingAttempt[]

  @@index([runId, testCaseId])
}

model TestHealingAttempt {
  id            String        @id @default(cuid())
  runId         String
  run           TestRun       @relation(fields: [runId], references: [id])
  testResultId  String
  testResult    TestResult    @relation(fields: [testResultId], references: [id])
  testCaseId    String
  testCase      TestCase      @relation(fields: [testCaseId], references: [id])
  attempt       Int           @default(1)
  status        HealingStatus @default(queued)
  summary       String?
  diff          String?
  error         String?
  prompt        Json?
  response      Json?
  artifactsPath String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([testResultId, attempt])
  @@index([runId, testCaseId])
  @@index([testResultId])
}

model TestStep {
  id        String   @id @default(cuid())
  caseId    String
  case      TestCase @relation(fields: [caseId], references: [id])
  idx       Int
  action    String   @db.Text
  expected  String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId, idx])
}

model TestCaseRun {
  id        String   @id @default(cuid())
  caseId    String
  case      TestCase @relation(fields: [caseId], references: [id])
  status    TestResultStatus
  note      String?  @db.Text
  userId    String?
  createdAt DateTime @default(now())

  @@index([caseId, createdAt])
}

model AgentSession {
  id           String             @id @default(cuid())
  userId       String
  user         User               @relation(fields: [userId], references: [id])
  projectId    String?
  project      Project?           @relation(fields: [projectId], references: [id])
  name         String?
  baseUrl      String
  instructions String?
  status       AgentSessionStatus @default(draft)
  meta         Json?
  pages        AgentPage[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([userId])
  @@index([projectId])
}

model AgentPage {
  id           String          @id @default(cuid())
  sessionId    String
  session      AgentSession    @relation(fields: [sessionId], references: [id])
  path         String
  url          String
  instructions String?
  status       AgentPageStatus @default(pending)
  summary      String?
  coverage     Json?
  error        String?
  scenarios    AgentScenario[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([sessionId])
}

model AgentScenario {
  id                String              @id @default(cuid())
  pageId            String
  page              AgentPage           @relation(fields: [pageId], references: [id])
  title             String
  coverageType      String
  description       String?
  tags              Json?
  risk              String?
  status            AgentScenarioStatus @default(suggested)
  steps             Json?
  specPath          String?
  attachedProjectId String?
  attachedProject   Project?            @relation(fields: [attachedProjectId], references: [id])
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([pageId])
  @@index([attachedProjectId])
}

model JiraIntegration {
  id           String            @id @default(cuid())
  userId       String
  user         User              @relation(fields: [userId], references: [id])
  projectId    String
  project      Project           @relation(fields: [projectId], references: [id])
  siteUrl      String
  email        String
  apiToken     String
  projectKey   String
  lastSyncedAt DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  requirements JiraRequirement[]

  @@unique([userId, projectId])
}

model JiraRequirement {
  id            String          @id @default(cuid())
  integrationId String
  integration   JiraIntegration @relation(fields: [integrationId], references: [id])
  issueKey      String
  summary       String
  status        String
  priority      String?
  url           String?
  syncedAt      DateTime        @default(now())

  @@unique([integrationId, issueKey])
}

model Integration {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  provider  String
  name      String?
  config    Json     @default("{}")
  secrets   Json?
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId, provider])
}

model SecurityScanJob {
  id         String             @id @default(cuid())
  projectId  String
  project    Project            @relation(fields: [projectId], references: [id])
  status     SecurityScanStatus @default(queued)
  phase      String?
  startedAt  DateTime?          @default(now())
  finishedAt DateTime?
  config     Json?
  summary    Json?
  error      String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  findings SecurityFinding[]

  @@index([projectId, createdAt])
}

model SecurityFinding {
  id          String              @id @default(cuid())
  scanId      String
  scan        SecurityScanJob     @relation(fields: [scanId], references: [id])
  type        SecurityFindingType
  severity    SecuritySeverity
  title       String
  description String?
  location    String?
  tool        String?
  evidence    Json?
  suggestion  String?
  status      String?
  createdAt   DateTime            @default(now())

  @@index([scanId, severity])
}

model ProjectSecret {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  name      String
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, key])
  @@index([projectId])
}

model CuratedSuite {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String
  rootRel   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, name])
  @@index([projectId])
}
